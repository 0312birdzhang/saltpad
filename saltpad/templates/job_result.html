{% extends "base_logged.html" %}

{% macro format_output(output, name, status, total, default_hide=False) %}
  {% if output %}
    <div {% if default_hide %}class="hide_control"{% endif %}>
      <h3 {% if default_hide %}class="hide_control"{% endif %}>{% if default_hide %}<i class="fa fa-chevron-right"></i><i class="fa fa-chevron-down" style="display: none"></i>{% endif %} {{ name }} {{ output | length }} / {{ total }}</h3>
      <div class="list-group {{ dic_class }}">
        {% for step_name, step in output.items() %}
          <a class="list-group-item list-group-item-{{ status }}">
            <h4><i class="fa fa-chevron-right"></i><i class="fa fa-chevron-down" style="display: none"></i> {{ step_name }}</h4>
            <ul class="sync-status-hidden">
              {% for k, v in step.items() %}<li>{{ k.decode('utf-8') }}: {{ (v|string()).decode('utf-8') }}</li>{% endfor %}
            </ul>
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}
{% endmacro %}

{% block page %}
<div id="page-wrapper">

<div class="row">
  <div class="col-lg-12">
    <h1>{{ job.info.Function }} on {{ job.info.Target }} started at {{ job.info.StartTime }} by {{ job.info.User }} <small>Arguments {{ job.info.Arguments }}</small></h1>
    {% if job.info.Function == 'state.highstate' and renderer != 'highstate' %}
    <div class="alert alert-warning"><a href="{{ url_for('job_result', jid=job.info.jid, renderer='highstate', minion=minion) }}">It looks like a state.highstate output, click here to see this page with the highstate renderer</a></div>
    {% elif job.info.Function != 'state.highstate' and renderer == 'highstate' %}
    <div class="alert alert-warning"><a href="{{ url_for('job_result', jid=job.info.jid, renderer='raw', minion=minion) }}">It doesn't looks like a state.highstate output, click here to see this page with the raw renderer</a></div>
    {% endif %}
    <ol class="breadcrumb">
      <li><a href="{{ url_for('index') }}"><i class="fa fa-dashboard"></i> SaltPad</a></li>
      <li><a href="{{ url_for('jobs') }}"><i class="fa fa-cloud"></i> Jobs</a></li>
      <li class="active"><i class="fa fa-cloud"></i> Job {{ job.info.jid }}</li>
    </ol>
  </div>
</div><!-- /.row -->

{% if job.status == 'running' %}

  <div class="col-lg-12">
    <div class="alert alert-info">
      <h1><i class="fa fa-refresh fa-spin"></i> Job is running, please wait !</h1>
      <script type="text/JavaScript">
      setTimeout(function(){
        window.location.reload(1);
      }, 5000);
      </script>
    </div>
  </div>

{% else %}

  <div class="row">
    <div class="col-lg-12">
      <h3> Minions:
      </h3>
      <div class="list-group">
        {% for minion in job.info.Minions %}
        <a href="#result-{{minion}}" class="list-group-item">{{ minion }}</a>
        {% endfor %}
      </ul>
    </div>
  </div><!-- /.row -->

  {% for minion in job.info.Minions %}

  {% if renderer == 'raw' %}

    <div class="row">
      <div class="col-lg-12" id="result-{{minion}}">
        <h3> {{ minion }} result:
        </h3>
        <pre id="tree-{{minion}}">
        </pre>
      </div>
    </div>
  {% elif renderer == 'highstate' %}

    {% set minion_job = job.return.get(minion, {'status': 'error', 'error': 'No return for this minion, minion is down or return is not yet available'}) %}

    {% if minion_job.status == 'error' %}

      <div class="col-lg-12 alert alert-error" id="result-{{minion}}">
          <h3> {{ minion }} error:
          </h3>
          <pre>{{ minion_job.error|join('\n') }}</pre>
      </div>

    {% else %}

      {% set total = minion_job['steps'] | length %}

      {% if minion_job['level'] == False %}{% set level="danger" %}{% elif minion_job['level'] == None %}{% set level="warning" %}{% else %}{% set level="success" %}{% endif %}
      <div class="col-lg-12" id="result-{{minion}}">
        <h3> {{ minion }} result:
        </h3>
        <div class="alert alert-{{ level }}">
          <h3>{{ total }} steps: {{ minion_job['highstate'][False] | length }} in errors, {{ minion_job['highstate'][None] | length }} in warning and {{ minion_job['highstate'][True] | length }} in success. </h3>
        </div>

        {{ format_output(minion_job['highstate'][False], 'Errors', 'danger', total) }}
        {{ format_output(minion_job['highstate'][None], 'Warnings (changes)', 'warning', total) }}
        {{ format_output(minion_job['highstate'][True], 'Success', 'success', total, True) }}
      </div>
    {% endif %}

  {% endif %}
  {% endfor %}
{% endif %}

{% endblock %}


{% block scripts %}
<script type="text/javascript">
$(function() {
  {% if job.status != 'running' %}

    {% if renderer=='highstate' %}

      $(".list-group-item").click(function(event) {
        $(this).find(".sync-status-hidden").toggle();
        $(this).find("h4 i.fa").toggle();
      });
      $("h3.hide_control").click(function(event) {
        $(this).parent().find("div.list-group").toggle();
        $(this).find("i.fa").toggle();
      });

    {% elif renderer=='raw' %}

      {% for minion in job.info.Minions %}
      json = {{ job.return.get(minion, 'No return')|tojson|safe }};
      document.getElementById("tree-{{ minion }}").innerHTML = JSONTree.create(json);
      {% endfor %}

    {% endif %}
  {% endif %}
});
</script>
{% endblock %}
