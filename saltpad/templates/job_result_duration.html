{% extends "job_result.html" %}
{% from "macros.jinja" import level_to_status %}

{% block job_result %}
<div class="row">

<div class="col-lg-12">
  <input type="checkbox" id="duration_checkbox" checked data-toggle="toggle" data-on="Minion duration" data-off="Global duration" data-onstyle="info" data-offstyle="primary">
</div>

{% for minion in job.info.Minions %}

    {% set minion_job = job.return.get(minion, {'status': 'error', 'error': ['No return for this minion, minion is down or return is not yet available']}) %}

    {% if minion_job.status == 'error' %}

      <div class="col-lg-12" id="result-{{minion}}">

          <div class="panel panel-danger">
            <div class="panel-heading">
              <h3>{{hiding_control('hide_control_minion')|safe }} {{ minion }} error</h3>
            </div>
            <div class="panel-body">
              <pre>{{ minion_job.error|trim() }}</pre>
            </div>
          </div>
      </div>


    {% else %}

      {% set total = minion_job['steps'] | length %}

      {% if minion_job['level'] == False %}{% set level="danger" %}{% elif minion_job['level'] == None %}{% set level="warning" %}{% else %}{% set level="success" %}{% endif %}
      <div class="col-lg-12" id="result-{{minion}}">
      <div class="panel panel-{{ level }}">
        <div class="panel-heading">
          <h3 class="hide_control">{{hiding_control('hide_control_minion', False)|safe }} {{ minion }} - {{ total }} steps: {{ minion_job['highstate'][False] | length }} in errors, {{ minion_job['highstate']['requirement_failed'] | length }} requirements failed, {{ minion_job['highstate'][None] | length }} in warning, {{ minion_job['highstate']['changes'] | length }} changes and {{ minion_job['highstate'][True] | length }} in success. </h3>
        </div>
        <div class="panel-body">
          <ol class="bar_chart">
              {% for step in minion_job['duration'] %}
                {% set step_percent = (step[1] / minion_job['total_duration']) * 100 %}
                {% set global_percent = (step[1] / job['max_duration']) * 100 %}
                <li>
                  <span class="step_duration">{{ '%0.2f' % step[1] }}ms</span>
                  <span class="step_percent odometer" data-minion-percent="{{ step_percent }}" data-global-percent="{{ global_percent }}">{{ '%0.2f' % step_percent }}%</span>
                  <div class="step_name step_{{ level_to_status(step[2]) }}" style="width:{{ step_percent }}%">{{ step[0] }}</div>
                </li>
              {% endfor %}
          </ol>
        </div>
      </div>
      </div>

    {% endif %}
{% endfor %}
{% endblock %}


{% block scripts %}
<script type="text/javascript">
$(function() {
  {% if job.status != 'running' %}

      $("a.list-group-item i.hide_control").click(function(event) {
        $(this).parents("a.list-group-item").first().find(".sync-status-hidden").toggle();
        $(this).parent().find("i.fa").toggle();
      });
      $("div.panel-heading i.hide_control").click(function(event) {
        $(this).parents("div.panel").first().find("div.list-group").toggle();
        $(this).parent().find("i.fa").toggle();
      });

      $("div.panel-heading i.hide_control_minion").click(function(event) {
        $(this).parents("div.panel").first().find(".panel-body").toggle();
        $(this).parent().find("i.fa").toggle();
      });

      $("#duration_checkbox").change(function() {
        var checked = $(this).prop("checked");

        if (checked === true) {
          var data_source = "minionPercent";
        } else {
          var data_source = "globalPercent";
        }

        $("span.step_percent").each(function(index, object) {
          var step_percent = $(this).data(data_source);
          $(this).next("div.step_name").width(step_percent + "%");
          $(this).html(step_percent.toFixed(2) + "%");
        });
      });

  {% endif %}
});
</script>
{% endblock %}
